### Task ID
M3-Fixes-Decode-Correctness-Perf

### Problem Statement
Address remaining M3 gaps:
- Correctness: Compressed decode emission must apply RoPE using absolute positions (S_raw-l..S_raw-1) before ϕ, not local 0..l-1.
- Tests: Add parity test that incremental decode emits the exact same compressed stream as prefill ϕ on the full sequence.
- Causality & group-consistency: Add decode-focused assertions (ranges end ≤ t+1; smoke for identical ranges across heads via group-reduce already proven in unit tests).
- Perf: Switch decode selection attention from per-(B,G) Python loop to packed varlen path (bucketed) for S=1 decode.

### Proposed Solution
- Extend `avg_pool_phi_rope_kv(K_raw, V_raw, l, d, pos=None)` to take optional absolute `pos: [S]` and apply RoPE using it; default to 0..S-1 when None.
- Prefill: pass `pos=torch.arange(S)`.
- Decode: when emitting, pass `pos=torch.arange(S_raw-l, S_raw)` for the last l raw tokens.
- Decode selection: use `grouped_selection_attention_packed` by wrapping the single-step `Q_t` and `sel_ranges` with S=1 dimension; keep parity fallback via env.
- Tests:
  - `test_cmp_decode_emission_parity`: compare K_cmp/V_cmp produced by prefill vs decode append+emit at the same S.
  - Keep existing counters and small-S equivalence.

### Checklist
- [ ] Add `pos` to `avg_pool_phi_rope_kv`; update all call sites.
- [ ] Decode path: use packed selection attention when `NSA_USE_SEL_PACK=1`.
- [ ] Add emission parity test.
- [ ] Run tests; ensure green.

### Status
In Progress
